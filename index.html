<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãŠè©±ã®æ£® | mofinaproject</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="screen">
    <section class="panel" aria-label="ãŠè©±ã®æ£® å¯¾è©±ã‚¨ãƒªã‚¢">

      <header class="banner">
        <h1>ğŸŒ¿ ãŠè©±ã®æ£®ã¸ã‚ˆã†ã“ã</h1>
        <p>ã‚‚ãµãƒãªã¨ã€ãŠè©±ã§ãã‚‹å ´æ‰€ã§ã™ã€‚</p>
      </header>

      <section class="chat" aria-label="ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢">
        <div id="chatLog" class="chatLog" aria-live="polite"></div>

        <form id="chatForm" class="chatForm" onsubmit="return false;">

          <input
            id="chatInput"
            class="chatInput"
            type="text"
            maxlength="300"
            placeholder="ã‚‚ãµãƒãªã«è©±ã—ã‹ã‘ã¦ã­â€¦"
            autocomplete="off"
          />
          <button id="chatBtn" class="chatBtn" type="submit">é€ä¿¡</button>
        </form>

        <p class="chatHint">â€»é€ä¿¡ã™ã‚‹ã¨æ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
      </section>

      <footer class="notice" aria-label="æ³¨æ„æ›¸ã">
        <p>â€»ã“ã“ã§ã®ãŠè©±ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
        <p>â€»åå‰ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ãªã©ã¯æ›¸ã‹ãªã„ã§ã­ã€‚</p>
      </footer>

    </section>
  </main>

<script>
const log = document.getElementById("chatLog");
const form = document.getElementById("chatForm");
const input = document.getElementById("chatInput");
const btn = document.getElementById("chatBtn");

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSå¯¾ç­–ï¼‰
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ­ã‚°ã«è¿½åŠ 
function add(role, text){
  const row = document.createElement("div");
  row.className = "msg " + (role === "user" ? "user" : "bot");
  row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
  return row;
}

function setDisabled(disabled){
  input.disabled = disabled;
  btn.disabled = disabled;
  btn.textContent = disabled ? "é€ä¿¡ä¸­â€¦" : "é€ä¿¡";
}

// é€ä¿¡å‡¦ç†
async function sendMessage(message){
  // UI
  add("user", message);
  const thinkingRow = add("bot", "â€¦ï¼ˆã‚‚ãµãƒãªãŒè€ƒãˆã¦ã‚‹ã‚ˆğŸƒï¼‰");

  setDisabled(true);

  try{
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    // HTTPã‚¨ãƒ©ãƒ¼ã‚‚æ‹¾ã†
    if(!res.ok){
      thinkingRow.querySelector(".bubble").textContent =
        `é€šä¿¡ã‚¨ãƒ©ãƒ¼ã ã‚ˆâ€¦ï¼ˆ${res.status}ï¼‰æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­`;
      return;
    }

    const data = await res.json().catch(() => ({}));
    const reply = data.reply || "â€¦ï¼ˆã†ã¾ãè¨€è‘‰ãŒå‡ºãªã‹ã£ãŸã¿ãŸã„ï¼‰";

    // thinking ã‚’ç½®æ›
    thinkingRow.querySelector(".bubble").textContent = reply;

  }catch(e){
    thinkingRow.querySelector(".bubble").textContent =
      "é€šä¿¡ã«å¤±æ•—ã—ãŸã‚ˆâ€¦ï¼ˆæ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ï¼‰";
  }finally{
    setDisabled(false);
    input.focus();
  }
}

// submitãƒãƒ³ãƒ‰ãƒ©
form.addEventListener("submit", (e) => {
  e.preventDefault();

  const message = input.value.trim();
  if(!message) return;

  // å…¥åŠ›ã‚¯ãƒªã‚¢ã—ã¦é€ä¿¡
  input.value = "";
  sendMessage(message);
});

// åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
input.focus();
</script>

</body>
</html>

